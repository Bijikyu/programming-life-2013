From aec71bec37d46144d885d0e9e0ca0e873fd4169b Mon Sep 17 00:00:00 2001
From: Steffan Sluis <steffansluis@gmail.com>
Date: Thu, 23 May 2013 11:16:57 +0200
Subject: [PATCH 2/2] Undo order reversed and tree updated on cell view update

---
 app/assets/javascripts/models/undotree.js.coffee   |  2 +-
 .../javascripts/views/raphael.main.js.coffee       | 23 ++++++++++------------
 app/assets/javascripts/views/undo.js.coffee        |  6 ++++++
 3 files changed, 17 insertions(+), 14 deletions(-)

diff --git a/app/assets/javascripts/models/undotree.js.coffee b/app/assets/javascripts/models/undotree.js.coffee
index d52efc9..7726abb 100644
--- a/app/assets/javascripts/models/undotree.js.coffee
+++ b/app/assets/javascripts/models/undotree.js.coffee
@@ -85,7 +85,7 @@ class Model.UndoTree extends Model.Tree
 		
 		back = @_current
 		until back is node or back is @_root
-			undo.push back
+			undo.unshift back
 			back = back._parent
 		
 		return undo
diff --git a/app/assets/javascripts/views/raphael.main.js.coffee b/app/assets/javascripts/views/raphael.main.js.coffee
index 4048bb5..6daf9c9 100644
--- a/app/assets/javascripts/views/raphael.main.js.coffee
+++ b/app/assets/javascripts/views/raphael.main.js.coffee
@@ -13,18 +13,23 @@ class View.Main extends View.RaphaelBase
 		super Raphael(container, 0,0) 
 
 		cell = new Model.Cell()
-		@_views.push  new View.Cell( @_paper, cell)
+
 		@_leftPane = new View.Pane(View.Pane.LEFT_SIDE, false) 
-		@_leftPane.addView( new View.Undo( @_leftPane._container , cell._tree ) )
-		@_views.push @_leftPane
 		@_rightPane = new View.Pane(View.Pane.RIGHT_SIDE)
-		#@_rightPane.addView( new View.Tree( @_rightPane._paper, cell._tree ) )
+
+		undo = new View.Undo( @_leftPane._container, cell._tree )
+		@_bind( 'view.cell.set', @, (cell) => 
+			undo.setTree(cell.cell._tree)
+		)
+
+		@_leftPane.addView( undo )
+		@_views.push  new View.Cell( @_paper, cell)
+		@_views.push @_leftPane
 		@_views.push @_rightPane
 
 		@resize()
 		$( window ).on( 'resize', @resize )
 
-		@_bind( 'view.cell.set', @, (cell) => @setTree(cell._tree) )
 
 		@draw()
 
@@ -69,11 +74,3 @@ class View.Main extends View.RaphaelBase
 		super()
 		@_paper.remove()
 		$( window ).unbind()
-	
-	# Sets the tree of the view
-	#
-	# @param tree [Model.UndoTree] The tree
-	#
-	setTree:( tree ) ->
-		@_tree = tree
-		@draw()
diff --git a/app/assets/javascripts/views/undo.js.coffee b/app/assets/javascripts/views/undo.js.coffee
index e06bea8..f140603 100644
--- a/app/assets/javascripts/views/undo.js.coffee
+++ b/app/assets/javascripts/views/undo.js.coffee
@@ -184,5 +184,11 @@ class View.Undo extends Helper.Mixable
 		node._object.redo()
 		@draw()
 
+	# Sets the tree of the view
+	#
+	# @param tree [Model.UndoTree] The tree to view
+	#
+	setTree: ( tree ) ->
+		@_tree = tree
 
 (exports ? this).View.Undo = View.Undo
-- 
1.8.0.msysgit.0

